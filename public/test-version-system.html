<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Sistema de Versiones</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #e8f5e8;
        border-color: #4caf50;
      }
      .error {
        background-color: #ffeaea;
        border-color: #f44336;
      }
      .info {
        background-color: #e3f2fd;
        border-color: #2196f3;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffc107;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      #results {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Test Sistema de Detecci√≥n de Versiones</h1>
      <p>
        Esta p√°gina te permite probar el sistema de detecci√≥n de versiones de
        FullControl GPS.
      </p>

      <div class="test-section info">
        <h3>üìã Estado Actual</h3>
        <p><strong>Versi√≥n esperada del servidor:</strong> 2025.06.1</p>
        <p>
          <strong>Versi√≥n almacenada del usuario:</strong>
          <span id="stored-version">Cargando...</span>
        </p>
        <p>
          <strong>Es primera vez:</strong>
          <span id="is-first-time">Cargando...</span>
        </p>
      </div>

      <div class="test-section">
        <h3>üîß Acciones de Prueba</h3>
        <button onclick="clearUserVersion()">üóëÔ∏è Simular Usuario Nuevo</button>
        <button onclick="setOldVersion()">üìÖ Simular Versi√≥n Antigua</button>
        <button onclick="testVersionDetection()">üîç Probar Detecci√≥n</button>
        <button onclick="refreshStatus()">üîÑ Actualizar Estado</button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      // Funci√≥n para mostrar el estado actual
      function refreshStatus() {
        const storedVersion = localStorage.getItem("fcgps_current_version");
        const isFirstTime = storedVersion === null;

        document.getElementById("stored-version").textContent =
          storedVersion || "Ninguna (usuario nuevo)";
        document.getElementById("is-first-time").textContent = isFirstTime
          ? "S√≠"
          : "No";
      }

      // Limpiar versi√≥n del usuario (simular usuario nuevo)
      function clearUserVersion() {
        localStorage.removeItem("fcgps_current_version");
        addResult(
          "‚úÖ Se elimin√≥ la versi√≥n almacenada. Usuario simulado como nuevo.",
          "success"
        );
        refreshStatus();
      }

      // Simular versi√≥n antigua
      function setOldVersion() {
        localStorage.setItem("fcgps_current_version", "2025.05.1");
        addResult(
          "‚úÖ Se estableci√≥ versi√≥n anterior (2025.05.1). Se deber√≠a detectar actualizaci√≥n.",
          "success"
        );
        refreshStatus();
      }

      // Probar el sistema de detecci√≥n
      async function testVersionDetection() {
        try {
          addResult("üîç Iniciando prueba de detecci√≥n...", "info");

          // 1. Obtener version.json
          const response = await fetch(
            "/version.json?t=" + new Date().getTime()
          );
          const versionData = await response.json();

          addResult(`üìã Datos del servidor obtenidos:`, "info");
          addResult(
            `<pre>${JSON.stringify(versionData, null, 2)}</pre>`,
            "info"
          );

          // 2. Simular la l√≥gica del UpdateService
          const serverVersion = versionData.version;
          const userStoredVersion = localStorage.getItem(
            "fcgps_current_version"
          );
          const isFirstTime = userStoredVersion === null;
          const hasNewVersion =
            userStoredVersion && userStoredVersion !== serverVersion;

          addResult(`üî¢ An√°lisis de versiones:`, "info");
          addResult(
            `<pre>Versi√≥n del servidor: ${serverVersion}
Versi√≥n del usuario: ${userStoredVersion || "null (nuevo usuario)"}
Es primera vez: ${isFirstTime}
Hay nueva versi√≥n: ${hasNewVersion}</pre>`,
            "info"
          );

          // 3. Determinar qu√© deber√≠a pasar
          if (isFirstTime) {
            addResult(
              "üéâ RESULTADO: Se deber√≠a mostrar notificaci√≥n de bienvenida",
              "success"
            );
          } else if (hasNewVersion) {
            addResult(
              "üîÑ RESULTADO: Se deber√≠a mostrar notificaci√≥n de actualizaci√≥n",
              "success"
            );
          } else {
            addResult(
              "‚úÖ RESULTADO: Usuario al d√≠a, no se muestra notificaci√≥n",
              "info"
            );
          }

          // 4. Verificar que la versi√≥n es correcta
          if (serverVersion === "2025.06.1") {
            addResult(
              "‚úÖ VERIFICACI√ìN: Versi√≥n del servidor es correcta (2025.06.1)",
              "success"
            );
          } else {
            addResult(
              `‚ùå ERROR: Versi√≥n incorrecta. Esperada: 2025.06.1, Obtenida: ${serverVersion}`,
              "error"
            );
          }
        } catch (error) {
          addResult(`‚ùå ERROR: ${error.message}`, "error");
          console.error("Error en la prueba:", error);
        }
      }

      // Funci√≥n para agregar resultados
      function addResult(message, type = "info") {
        const resultsDiv = document.getElementById("results");
        const resultDiv = document.createElement("div");
        resultDiv.className = `test-section ${type}`;
        resultDiv.innerHTML = `<p>${message}</p>`;
        resultsDiv.appendChild(resultDiv);

        // Scroll al final
        resultDiv.scrollIntoView({ behavior: "smooth" });
      }

      // Inicializar al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", function () {
        refreshStatus();
        addResult(
          "üí° P√°gina de pruebas cargada. Usa los botones para probar el sistema.",
          "info"
        );
      });
    </script>
  </body>
</html>
